#!@SHELL@
#
# Compile a tiny Râ·RS program with the CHICKEN 5 compiler. Run the
# program.
#

prog_scm=`@abs_top_builddir@/tempname`.scm
prog_exe=`echo ${prog_scm} | sed 's/scm$/exe/'`

cat > "${prog_scm}" <<EOF
(import (scheme base))
(import (scheme write))
(import (scheme process-context))
(import (pipchix essentials))
(import (pipchix expressions))
(import (pipchix macros))
(import (pipchix continuation-capture))
(import (pipchix string-manipulation))
(import (pipchix abstract-syntax-tree))
(import (pipchix nix-embed))
(import (pipchix nix-list))
(import (pipchix nix-set))
(output-nix-abstract-syntax-tree $1)
(exit 0)
EOF

eggdir="@abs_top_builddir@/chicken/eggs/5/pipchix"

new_repository_path ()
{
    @CSI_5@ -n -b -R r7rs -R utf8-srfi-13 -R chicken.platform \
          -e '
          (display
           (string-join
            (cons "'"${eggdir}"'" (repository-path))
             ":"))'
}

env LC_ALL="@TEST_LOCALE@" \
    LANG="@TEST_LOCALE@" \
    @CSC_5@ -I "${eggdir}" -R utf8 -R r7rs -X r7rs \
      "${prog_scm}" -o "${prog_exe}"

env LC_ALL="@TEST_LOCALE@" \
    LANG="@TEST_LOCALE@" \
    CHICKEN_REPOSITORY_PATH=`new_repository_path` \
    ./${prog_exe}

rm "${prog_scm}" "${prog_exe}"

exit 0

# local variables:
# mode: shell-script
# sh-shell: sh
# end:
