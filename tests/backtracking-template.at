# Copyright © 2026 Barry Schwartz
#
# This file is part of Pipchix.
#
# Permission is hereby granted, free of charge, to any person obtaining
# a copy of Pipchix and associated documentation files (the
# "Software"), to deal in the Software without restriction, including
# without limitation the rights to use, copy, modify, merge, publish,
# distribute, sublicense, and/or sell copies of the Software, and to
# permit persons to whom the Software is furnished to do so, subject to
# the following conditions:
# 
# The above copyright notice and this permission notice shall be
# included in all copies or substantial portions of the Software.
# 
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
# EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
# MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
# NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
# LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
# OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
# WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
#

AT_SETUP([setup_message(backtracking)])

AT_KEYWORDS([default_keywords backtracking])

m4_define([sexpr],
  [(scheme->nix
    (let ((x 1234))
      (attempt
        (set! x 5678))
      x))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([(5678)·])],[])

m4_define([sexpr],
  [(scheme->nix
    (let ((x 1234))
      (attempt
        (fail)
        (set! x 5678))
      x))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([(1234)·])],[])

m4_define([sexpr],
  [(scheme->nix
    (let ((x 1234))
      (attempt
        (reversible-set! ((x 5678))
          x))))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([(5678)·])],[])

m4_define([sexpr],
  [(scheme->nix
    (let ((x 1234))
      (attempt
        (reversible-set! ((x 5678))))
      x))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([(5678)·])],[])

m4_define([sexpr],
  [(scheme->nix
    (let ((x 1234)
          (y "1234"))
      (attempt
        (reversible-set! ((x 5678)
                          (y "5678"))
          (unless (and (= x 5678) (equal? y "5678"))
            (raise "BIG ERROR"))
          (fail)))
      (list x y)))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([[[·(1234)·("1234")·]·]])],[])

m4_define([sexpr],
  [(scheme->nix
    (let ((x (vector 1234))
          (y (vector "1234")))
      (attempt
        (reversible-vector-set! (((x 0) 5678)
                                 ((y 0) "5678"))
          (unless (and (= (vector-ref x 0) 5678)
                       (equal? (vector-ref y 0) "5678"))
            (raise "BIG ERROR"))
          (fail)))
      (list (vector-ref x 0) (vector-ref y 0))))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([[[·(1234)·("1234")·]·]])],[])

m4_define([sexpr],
  [(scheme->nix
    (let ((x (list 1234))
          (y (list "1234")))
      (attempt
        (reversible-list-set! (((x 0) 5678)
                               ((y 0) "5678"))
          (unless (and (= (list-ref x 0) 5678)
                       (equal? (list-ref y 0) "5678"))
            (raise "BIG ERROR"))
          (fail)))
      (list x y)))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([[[·[·(1234)·]·[·("1234")·]·]·]])],[])

AT_CLEANUP

# local variables:
# mode: autoconf
# coding: utf-8
# end:
