#!@SHELL@
#
# Compile a tiny Râ·RS program with the Gerbil Scheme compiler.
#

prog_scm=`basename $(TMPDIR=. mktemp 2>/dev/null) 2>/dev/null || echo tmp."${RANDOM}"`.scm
prog_exe=`echo ${prog_scm} | sed 's|scm$|exe|'`

printf '(prelude: :scheme/r7rs)' > gerbil.pkg

cat > "${prog_scm}" <<EOF
(import (scheme base))
(import (scheme process-context))
(import (scheme write))
(import (pipchix base))
(import (pipchix continuation-capture))
(import (pipchix abstract-syntax-tree))
(import (pipchix nix-embed))
(import (pipchix nix-list))
(import (pipchix nix-set))
(import (pipchix string-manipulation))
(define (main . args)
  (output-nix-abstract-syntax-tree $1)
  (exit 0))
(export main)
EOF

env LC_ALL="@TEST_LOCALE@" \
    LANG="@TEST_LOCALE@" \
    GERBIL_PATH='@abs_builddir@/gerbil' \
    GERBIL_LOADPATH='@abs_top_builddir@/r7rs' \
    @GXC@ -no-ssxi -o "${prog_exe}" -exe "${prog_scm}" \
    1>/dev/null 2>/dev/null

./"${prog_exe}"

rm -f "${prog_scm}" "${prog_exe}" gerbil.pkg

exit 0

# local variables:
# mode: shell-script
# sh-shell: sh
# end:
