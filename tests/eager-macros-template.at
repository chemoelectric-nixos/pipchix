# Copyright © 2026 Barry Schwartz
#
# This file is part of Pipchix.
#
# Permission is hereby granted, free of charge, to any person obtaining
# a copy of Pipchix and associated documentation files (the
# "Software"), to deal in the Software without restriction, including
# without limitation the rights to use, copy, modify, merge, publish,
# distribute, sublicense, and/or sell copies of the Software, and to
# permit persons to whom the Software is furnished to do so, subject to
# the following conditions:
# 
# The above copyright notice and this permission notice shall be
# included in all copies or substantial portions of the Software.
# 
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
# EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
# MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
# NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
# LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
# OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
# WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
#

AT_SETUP([setup_message(eager-macros)])

AT_KEYWORDS([default_keywords eager-macros])

# Currently the library does not work with the CHICKEN 5 compiler,
# unless you first actually install the ‘pipchix’ egg.
AT_SKIP_IF(m4_if(implementation,[csc-5],[true],[false]))

m4_define([sexpr],[(scheme->nix (call-with-values (lambda () (identity:e 5 1 2 3 4 7)) list))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([@<:@·(5)·(1)·(2)·(3)·(4)·(7)·@:>@·])],[])

m4_define([sexpr],[(scheme->nix (identity:e 5))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([(5)·])],[])

m4_define([sexpr],[(scheme->nix (constant:e 5 1 2 3 4 7))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([(5)·])],[])

dnl  What a gensym ‘is’ depends on the Scheme implementation. Let us
dnl  check merely that something other than #f is created.
m4_define([sexpr],
  [(scheme->nix (and (gensym:e) @%:@t))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([nix_true])],[])

m4_define([sexpr],
  [(scheme->nix (proper-list?:e (generate-temporaries:e '\''(1 2 3 4 5 6 7))))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([nix_true])],[])

m4_define([sexpr],
  [(scheme->nix (circular-list?:e (generate-temporaries:e '\''(1 2 3 4 5 6 7))))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([nix_false])],[])

m4_define([sexpr],
  [(scheme->nix (dotted-list?:e (generate-temporaries:e '\''(1 2 3 4 5 6 7))))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([nix_false])],[])

m4_define([sexpr],
  [(scheme->nix (proper-list?:e (circular-list:e '\''(1 2 3 4 5 6 7))))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([nix_false])],[])

m4_define([sexpr],
  [(scheme->nix (circular-list?:e (circular-list:e '\''(1 2 3 4 5 6 7))))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([nix_true])],[])

m4_define([sexpr],
  [(scheme->nix (dotted-list?:e (circular-list:e '\''(1 2 3 4 5 6 7))))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([nix_false])],[])

m4_define([sexpr],
  [(scheme->nix (proper-list?:e (third:e '\''(1 2 3 4 5 6 7))))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([nix_false])],[])

m4_define([sexpr],
  [(scheme->nix (circular-list?:e (third:e '\''(1 2 3 4 5 6 7))))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([nix_false])],[])

m4_define([sexpr],
  [(scheme->nix (dotted-list?:e (third:e '\''(1 2 3 4 5 6 7))))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([nix_true])],[])

m4_define([sexpr],
  [(scheme->nix (dotted-list?:e (cons*:e 1 2 (third:e '\''(1 2 3 4 5 6 7)))))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([nix_true])],[])

m4_define([sexpr],
  [(scheme->nix (pair?:e (identity:e '\''(1 2 3 4 5 6 7))))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([nix_true])],[])

m4_define([sexpr],
  [(scheme->nix (pair?:e (third:e '\''(1 2 3 4 5 6 7))))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([nix_false])],[])

m4_define([sexpr],
  [(scheme->nix (not-pair?:e (identity:e '\''(1 2 3 4 5 6 7))))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([nix_false])],[])

m4_define([sexpr],
  [(scheme->nix (not-pair?:e (third:e '\''(1 2 3 4 5 6 7))))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([nix_true])],[])

m4_define([sexpr],
  [(scheme->nix (null-list?:e '\''(1 2 3 4 5 6 7)))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([nix_false])],[])

m4_define([sexpr],
  [(scheme->nix (null-list?:e '\''()))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([nix_true])],[])

m4_define([sexpr],
  [(scheme->nix (null?:e '\''(1 2 3 4 5 6 7)))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([nix_false])],[])

m4_define([sexpr],
  [(scheme->nix (null?:e '\''()))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([nix_true])],[])

m4_define([sexpr],
  [(scheme->nix (null?:e 5))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([nix_false])],[])

m4_define([sexpr],
  ;; In defiance of those who suggest (because they believe
  ;; floating point numbers are MAGICALLY ‘inexact’) that there
  ;; should be no = for floating point:
  [(scheme->nix (list=:e = '\''(1 2 3 4 5 6 7)
                           '\''(1.0 2.0 3.0 4.0 5.0 6.0 7.0)))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([nix_true])],[])

m4_define([sexpr],
  [(scheme->nix (list=:e = '\''(1 2 3 4 5 6 7)
                           '\''(1.0 2.0 3.1 4.0 5.0 6.0 7.0)))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([nix_false])],[])

m4_define([sexpr],
  [(scheme->nix (exact-integer?:e 5.0))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([nix_false])],[])

m4_define([sexpr],
  [(scheme->nix (exact-integer?:e 5))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([nix_true])],[])

m4_define([sexpr],
  [(scheme->nix (length:e (generate-temporaries:e '\''(1 2 3 4 5 6 7))))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([(7)·])],[])

m4_define([sexpr],
  [(scheme->nix (length+:e (generate-temporaries:e '\''(1 2 3 4 5 6 7))))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([(7)·])],[])

m4_define([sexpr],[(scheme->nix (even?:e 173))])
check_unquoted([run_scheme 'sexpr'],[0],[interpunct_nl([nix_false])],[])
m4_define([sexpr],[(scheme->nix (even?:e 174))])
check_unquoted([run_scheme 'sexpr'],[0],[interpunct_nl([nix_true])],[])
m4_define([sexpr],[(scheme->nix (odd?:e 173))])
check_unquoted([run_scheme 'sexpr'],[0],[interpunct_nl([nix_true])],[])
m4_define([sexpr],[(scheme->nix (odd?:e 174))])
check_unquoted([run_scheme 'sexpr'],[0],[interpunct_nl([nix_false])],[])

dnl  The regular ‘if’ composes:
m4_define([sexpr],
  [(scheme->nix
    (reverse:e
     (if (even?:e (length:e (list:e 1 2 3 4)))
       (list:e 1 2 3)
       (list:e 4 5 6))))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([@<:@·(3)·(2)·(1)·@:>@·])],[])

dnl  The regular ‘and’ composes:
m4_define([sexpr],
  [(scheme->nix
    (append:e (list:e 8 7 6 5)
              (and (eqv?:e 1 1)
                   (reverse:e (list:e 1 2 3 4)))))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([@<:@·(8)·(7)·(6)·(5)·(4)·(3)·(2)·(1)·@:>@·])],[])

dnl  The regular ‘or’ composes:
m4_define([sexpr],
  [(scheme->nix
    (append:e (list:e 8 7 6 5)
              (or (eqv?:e 1 2)
                  (reverse:e (list:e 1 2 3 4)))))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([@<:@·(8)·(7)·(6)·(5)·(4)·(3)·(2)·(1)·@:>@·])],[])

m4_define([sexpr],
  [(scheme->nix (length+:e (circular-list:e '\''(1 2 3 4 5 6 7))))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([nix_false])],[])

m4_define([sexpr],
  [(scheme->nix (count:e even? '\''(1 2 3 4 5 6 7)))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([(3)·])],[])

m4_define([sexpr],
  [(scheme->nix (every:e (lambda (x) (and x @%:@t))
                         (generate-temporaries:e '\''(1 2 3 4 5 6 7))))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([nix_true])],[])

m4_define([sexpr],
  [(scheme->nix (any:e (lambda (x) (not (and x @%:@t)))
                       (generate-temporaries:e '\''(1 2 3 4 5 6 7))))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([nix_false])],[])

m4_define([sexpr],
  [(scheme->nix (cons:e 0 `(1 2)))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([@<:@·(0)·(1)·(2)·@:>@·])],[])

m4_define([sexpr],
  [(scheme->nix (xcons:e `(1 2) 0))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([@<:@·(0)·(1)·(2)·@:>@·])],[])

m4_define([sexpr],
  [(scheme->nix (cons*:e 3 4 5 `(1 2) ))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([@<:@·(3)·(4)·(5)·(1)·(2)·@:>@·])],[])

m4_define([sexpr],
  [(scheme->nix (list:e 3 4 5 `(1 2) ))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([@<:@·(3)·(4)·(5)·@<:@·(1)·(2)·@:>@·@:>@·])],[])

m4_define([sexpr],
  [(scheme->nix (list-tabulate:e 5 number->string))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([@<:@·("0")·("1")·("2")·("3")·("4")·@:>@·])],[])

m4_define([sexpr],
  [(scheme->nix (map:e number->string (iota:e 5)))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([@<:@·("0")·("1")·("2")·("3")·("4")·@:>@·])],[])

m4_define([sexpr],
  [(scheme->nix (append-map:e (lambda (x) (list x (- x))) (list:e 1 3 8)))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([@<:@·(1)·(-1)·(3)·(-3)·(8)·(-8)·@:>@·])],[])

m4_define([sexpr],
  [(scheme->nix (take:e (circular-list:e 3 4 5) 8))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([@<:@·(3)·(4)·(5)·(3)·(4)·(5)·(3)·(4)·@:>@·])],[])

m4_define([sexpr],
  [(scheme->nix (drop:e (take:e (circular-list:e 3 4 5) 8) 2))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([@<:@·(5)·(3)·(4)·(5)·(3)·(4)·@:>@·])],[])

m4_define([sexpr],
  [(scheme->nix (take-right:e (drop:e (take:e (circular-list:e 3 4 5) 8) 2) 4))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([@<:@·(4)·(5)·(3)·(4)·@:>@·])],[])

m4_define([sexpr],
  [(scheme->nix (last-pair:e (take-right:e (drop:e (take:e (circular-list:e 3 4 5) 8) 2) 4)))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([@<:@·(4)·@:>@·])],[])

m4_define([sexpr],
  [(scheme->nix (drop-right:e (take-right:e (drop:e (take:e (circular-list:e 3 4 5) 8) 2) 4) 2))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([@<:@·(4)·(5)·@:>@·])],[])

m4_define([sexpr],
  [(scheme->nix (make-list:e 5 6))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([@<:@·(6)·(6)·(6)·(6)·(6)·@:>@·])],[])

m4_define([sexpr],
  [(scheme->nix (append:e `(1 2) (append:e `(3 4) `(5 6) (append:e `(7 8) `(9 10)))))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([@<:@·(1)·(2)·(3)·(4)·(5)·(6)·(7)·(8)·(9)·(10)·@:>@·])],[])

m4_define([sexpr],
  [(scheme->nix (concatenate:e (list:e `(1 2) `(3 4) `(5 6) `(7 8) `(9 10))))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([@<:@·(1)·(2)·(3)·(4)·(5)·(6)·(7)·(8)·(9)·(10)·@:>@·])],[])

m4_define([sexpr],
  [(scheme->nix (zip:e `(1 2) `(3 4) `(5 6) `(7 8) `(9 10)))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([@<:@·@<:@·(1)·(3)·(5)·(7)·(9)·@:>@·@<:@·(2)·(4)·(6)·(8)·(10)·@:>@·@:>@·])],[])

m4_define([sexpr],[(scheme->nix (reverse:e (reverse:e (reverse:e `(1 2 3 4)))))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([@<:@·(4)·(3)·(2)·(1)·@:>@·])],[])

m4_define([sexpr],[(scheme->nix (append-reverse:e `(1 2 3 4) `("a" "b")))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([@<:@·(4)·(3)·(2)·(1)·("a")·("b")·@:>@·])],[])

m4_define([sexpr],
  [(scheme->nix
    (fold:e cons* '\''() '\''("a" "b" "c") '\''(1 2 3 4 5)))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([@<:@·("c")·(3)·("b")·(2)·("a")·(1)·@:>@·])],[])

m4_define([sexpr],
  [(scheme->nix
    (fold-right:e cons* '\''() '\''("a" "b" "c") '\''(1 2 3 4 5)))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([@<:@·("a")·(1)·("b")·(2)·("c")·(3)·@:>@·])],[])

m4_define([sexpr],
  [(scheme->nix
    (pair-fold:e cons* '\''() '\''("a" "b" "c") '\''(1 2 3 4 5)))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([[[·[·("c")·]·[·(3)·(4)·(5)·]·[·("b")·("c")·]·[·(2)·(3)·(4)·(5)·]·[·("a")·("b")·("c")·]·[·(1)·(2)·(3)·(4)·(5)·]·]·]])],[])

m4_define([sexpr],
  [(scheme->nix
    (pair-fold-right:e cons* '\''() '\''("a" "b" "c") '\''(1 2 3 4 5)))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([[[·[·("a")·("b")·("c")·]·[·(1)·(2)·(3)·(4)·(5)·]·[·("b")·("c")·]·[·(2)·(3)·(4)·(5)·]·[·("c")·]·[·(3)·(4)·(5)·]·]·]])],[])

m4_define([sexpr],
  [(scheme->nix
    (unfold:e (lambda (x) (> x 10))
              (lambda (x) (* x x))
              (lambda (x) (+ x 1))
              1))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([@<:@·(1)·(4)·(9)·(16)·(25)·(36)·(49)·(64)·(81)·(100)·@:>@·])],[])

m4_define([sexpr],
  [(scheme->nix
    (unfold-right:e zero?
                    (lambda (x) (* x x))
                    (lambda (x) (- x 1))
                    10))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([@<:@·(1)·(4)·(9)·(16)·(25)·(36)·(49)·(64)·(81)·(100)·@:>@·])],[])

m4_for([N],[1],[10],[1],[
m4_pushdef([ORDINAL],m4_case(N,[1],[first],
[2],[second],
[3],[third],
[4],[fourth],
[5],[fifth],
[6],[sixth],
[7],[seventh],
[8],[eighth],
[9],[ninth],
[10],[tenth],
[1],[car],
[2],[cadr],
[3],[caddr],
[4],[cadddr],
[10],[last]))
m4_define([sexpr],
  [(scheme->nix (ORDINAL:e (list:e 15 25 35 45 55 65 75 85 95 105)))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([(N[]5)·])],[])
m4_popdef([ORDINAL])
])

m4_for([I],[1],[10],[1],[
m4_define([sexpr],
  [(scheme->nix (list-ref:e (list:e 0 15 25 35 45 55 65 75 85 95 105) I))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([(I[]5)·])],[])
])

m4_define([sexpr],
  [(scheme->nix (length-even?:e `(1 2 3 4)))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([nix_true])],[])

m4_define([sexpr],
  [(scheme->nix (length-even?:e `(1 2 3 4 5)))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([nix_false])],[])

m4_define([sexpr],
  [(scheme->nix (length-odd?:e `(1 2 3 4)))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([nix_false])],[])

m4_define([sexpr],
  [(scheme->nix (length-odd?:e `(1 2 3 4 5)))])
check_unquoted([run_scheme 'sexpr'],[0],
  [interpunct_nl([nix_true])],[])

AT_CLEANUP

# local variables:
# mode: autoconf
# coding: utf-8
# end:
