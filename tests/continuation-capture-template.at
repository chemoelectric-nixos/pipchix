# Copyright © 2025 Barry Schwartz
#
# This file is part of Pipchix.
#
# Permission is hereby granted, free of charge, to any person obtaining
# a copy of Pipchix and associated documentation files (the
# "Software"), to deal in the Software without restriction, including
# without limitation the rights to use, copy, modify, merge, publish,
# distribute, sublicense, and/or sell copies of the Software, and to
# permit persons to whom the Software is furnished to do so, subject to
# the following conditions:
# 
# The above copyright notice and this permission notice shall be
# included in all copies or substantial portions of the Software.
# 
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
# EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
# MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
# NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
# LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
# OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
# WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
#

AT_SETUP([setup_message(continuation-capture)])

AT_KEYWORDS([default_keywords continuation continuations
             continuation-capture continuation-graft
             continuation-return call/cc])

# Based on the try-catch-throw example from Feeley,
# ‘A Better API for First-Class Continuations’,
# http://www.iro.umontreal.ca/~feeley/papers/FeeleySW01.pdf
# https://web.archive.org/web/20250701033312/http://www.iro.umontreal.ca/~feeley/papers/FeeleySW01.pdf
m4_define([sexpr],
  [(let ((try-catch
           (lambda (catcher thunk)
             (continuation-capture
              (lambda (cont)
               (with-exception-handler
                 (lambda (e)
                   (continuation-graft
                    cont (lambda () (catcher e))))
                 (lambda ()
                   (let ((result (thunk)))
                     (lambda () result))))))))
         (str @%:@f))
     (try-catch
       (lambda (e)
         (nix-embed str))
       (lambda ()
         (set! str "erroneous operation")
         (error "erroneous operation" `()))))])
check_unquoted([run_scheme 'sexpr'],[0],[erroneous operation],[])

m4_define([sexpr],
  [(let ((obj (current-continuation)))
     (cond ((continuation? obj)
            (continuation-return
             obj "This time obj will be a string!"))
           (else (nix-embed obj))))])
check_unquoted([run_scheme 'sexpr'],[0],
  [This time obj will be a string!],[])

m4_define([sexpr],
  [(let ((obj (current-continuation)))
     (cond ((continuation? obj)
            ((continuation->procedure obj)
             "This time obj will be another string!"))
           (else (nix-embed obj))))])
check_unquoted([run_scheme 'sexpr'],[0],
  [This time obj will be another string!],[])

m4_define([sexpr],
  [(let* ((lst (list 11 22 33 44 55))
          (goal 44)
          (p lst)
          (i 0))
     (let ((loop (current-continuation)))
       (cond ((= (car p) goal)
              (nix-embed (string-append (number->string i)
                                        " "
                                        (number->string (car p)))))
             (else
              (set! i (+ i 1))
              (set! p (cdr p))
              (goto-continuation loop)))))])
check_unquoted([run_scheme 'sexpr'],[0],[3 44],[])

AT_CLEANUP

])

# local variables:
# mode: autoconf
# coding: utf-8
# end:
