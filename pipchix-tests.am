# Copyright Â© 2025 Barry Schwartz
# 
# Permission is hereby granted, free of charge, to any person obtaining
# a copy of Pipchix and associated documentation files (the
# "Software"), to deal in the Software without restriction, including
# without limitation the rights to use, copy, modify, merge, publish,
# distribute, sublicense, and/or sell copies of the Software, and to
# permit persons to whom the Software is furnished to do so, subject to
# the following conditions:
# 
# The above copyright notice and this permission notice shall be
# included in all copies or substantial portions of the Software.
# 
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
# EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
# MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
# NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
# LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
# OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
# WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

#
# Tests using the simple parallel test harness of GNU Automake.
#

#
# FIXME: Setting CHICKEN_REPOSITORY_PATH here may not be a good
#        approach once CHICKEN 6 can be supported alongside CHICKEN 5.
#        For now it is the approach used to set the environment for
#        the compiled versions of test programs.
#
AM_TESTS_ENVIRONMENT = \
	LC_ALL=C.utf8; export LC_ALL; \
	LANG=C.utf8; export LANG;

if CSI_5
@GNU@define get-chicken-5-repository-path
@GNU@$(shell ($(CSI_5) -n -b -R r7rs -R utf8-srfi-13 -R chicken.platform \
@GNU@    -e '(display (string-join (cons "$(abs_builddir)/$(CHICKEN_5_EGGDIR)" (repository-path)) ":"))'))
@GNU@endef
else !CSI_5
@GNU@define get-chicken-5-repository-path
@GNU@$(shell true)
@GNU@endef
endif !CSI_5

R6RS_TEST_TOP = '\#!r6rs \
 \
(import (except (rnrs)) \
        (pipchix abstract-syntax-tree) \
        (pipchix nix-embed) \
        (pipchix nix-list) \
        (pipchix nix-set)) \
 \
(define PASS 0) \
(define FAIL 1) \
(define SKIP 77) \
(define ERROR 99) \
 \
(define result (make-string 0)) \
(define (fill-result s) \
  (set! result (string-append result s)))'

R7RS_TEST_TOP = ' \
(import (scheme base)) \
(import (scheme process-context)) \
(import (scheme write)) \
(import (pipchix abstract-syntax-tree)) \
(import (pipchix nix-embed)) \
(import (pipchix nix-list)) \
(import (pipchix nix-set)) \
 \
(define PASS 0) \
(define FAIL 1) \
(define SKIP 77) \
(define ERROR 99) \
 \
(define result (make-string 0)) \
(define (fill-result s) \
  (set! result (string-append result s)))'

tests/r7rs/chicken-5/%-csi: tests/%.scm \
                            chicken-5-egg-stamp \
                            GNUmakefile
	$(call v,AWK) $(MKDIR_P) $(@D) && \
	$(AWK) 'BEGIN{print "#!$(ENV_S) CHICKEN_REPOSITORY_PATH=\"$(get-chicken-5-repository-path)\" $(CSI_5) -n -b -R utf8 -R r7rs -s"; \
	              print "'$(R7RS_TEST_TOP)'"} \
	        {print}' $(<) \
	  > $(@).tmp && mv $(@){.tmp,} && chmod +x $(@)

tests/r7rs/chicken-5/%-csc: tests/%.scm \
                            chicken-5-egg-stamp \
                            GNUmakefile
	$(call v,AWK/CSC) $(MKDIR_P) $(@D) && \
	$(AWK) 'BEGIN{print "'$(R7RS_TEST_TOP)'"} \
	        {print}' $(<) \
	  > $(@).tmp.scm.tmp && mv $(@).tmp.scm{.tmp,} && \
	$(CSC_5) -I $(CHICKEN_5_EGGDIR) -R utf8 -R r7rs -X r7rs $(@).tmp.scm -o $(@)-exe$(EXEEXT) && \
	rm -f $(@).tmp.scm && \
	$(AWK) 'BEGIN{print "#!$(SHELL)"; \
	              print "CHICKEN_REPOSITORY_PATH=\"$(get-chicken-5-repository-path)\""; \
	              print "export CHICKEN_REPOSITORY_PATH"; \
	              print "exec \"$(abs_builddir)/$(@)-exe$(EXEEXT)\""}' \
	  > $(@).tmp && mv $(@){.tmp,} && chmod +x $(@)

tests/r6rs/%-chez: tests/%.scm $(R6RS_SCHEME) GNUmakefile
	$(call v,AWK) $(MKDIR_P) $(@D) && \
	$(AWK) 'BEGIN{print "#!$(ENV_S) $(CHEZ_SCHEME) --libdirs '$(abs_builddir)/r6rs:' --program"; \
	              print "'$(R6RS_TEST_TOP)'"} \
	        {print}' $(<) \
	  > $(@).tmp && mv $(@){.tmp,} && chmod +x $(@)

tests/r7rs/%-chibi: tests/%.scm $(R7RS_SCHEME) GNUmakefile
	$(call v,AWK) $(MKDIR_P) $(@D) && \
	$(AWK) 'BEGIN{print "#!$(CHIBI_SCHEME) -I'$(abs_builddir)/r7rs'"; \
	              print "'$(R7RS_TEST_TOP)'"} \
	        {print}' $(<) \
	  > $(@).tmp && mv $(@){.tmp,} && chmod +x $(@)

tests/r7rs/%-gauche: tests/%.scm $(R7RS_SCHEME) GNUmakefile
	$(call v,AWK) $(MKDIR_P) $(@D) && \
	$(AWK) 'BEGIN{print "#!$(GAUCHE) -I'$(abs_builddir)/r7rs'"; \
	              print "'$(R7RS_TEST_TOP)'"} \
	        {print}' $(<) \
	  > $(@).tmp && mv $(@){.tmp,} && chmod +x $(@)

tests/r6rs/%-guile: tests/%.scm $(R6RS_SCHEME) GNUmakefile
	$(call v,AWK) $(MKDIR_P) $(@D) && \
	$(AWK) 'BEGIN{print "#!$(GUILE) \\"; \
	              print "-L '$(abs_builddir)/r6rs' --r6rs --no-auto-compile -s"; \
	              print "!#"; \
	              print "'$(R6RS_TEST_TOP)'"} \
	        {print}' $(<) \
	  > $(@).tmp && mv $(@){.tmp,} && chmod +x $(@)

tests/r7rs/%-guile: tests/%.scm $(R7RS_SCHEME) GNUmakefile
	$(call v,AWK) $(MKDIR_P) $(@D) && \
	$(AWK) 'BEGIN{print "#!$(GUILE) \\"; \
	              print "-L '$(abs_builddir)/r7rs' --r7rs --no-auto-compile -s"; \
	              print "!#"; \
	              print "'$(R7RS_TEST_TOP)'"} \
	        {print}' $(<) \
	  > $(@).tmp && mv $(@){.tmp,} && chmod +x $(@)

tests/r6rs/%-loko: tests/%.scm $(R6RS_SCHEME) GNUmakefile
	$(call v,AWK) $(MKDIR_P) $(@D) && \
	$(AWK) 'BEGIN{print "#!$(ENV_S) LOKO_LIBRARY_PATH=\"$(abs_builddir)/r6rs\" $(LOKO) --program"; \
	              print "'$(R6RS_TEST_TOP)'"} \
	        {print}' $(<) \
	  > $(@).tmp && mv $(@){.tmp,} && chmod +x $(@)

tests/r7rs/%-loko: tests/%.scm $(R7RS_SCHEME) GNUmakefile
	$(call v,AWK) $(MKDIR_P) $(@D) && \
	$(AWK) 'BEGIN{print "#!$(ENV_S) LOKO_LIBRARY_PATH=\"$(abs_builddir)/r7rs\" $(LOKO) --script"; \
	              print "'$(R7RS_TEST_TOP)'"} \
	        {print}' $(<) \
	  > $(@).tmp && mv $(@){.tmp,} && chmod +x $(@)

#
# FIXME: MIT/GNU Scheme does not seem able to output the actual status
#        code given to (exit STATUS). Thus only PASS and FAIL may be
#        effective.
#
tests/r7rs/%-mit: tests/%.scm $(R7RS_SCHEME) GNUmakefile
	$(call v,AWK) $(MKDIR_P) $(@D) && \
	$(AWK) 'BEGIN{print "'$(R7RS_TEST_TOP)'"} \
	        {print}' $(<) \
	  > $(@).tmp.scm.tmp && mv $(@).tmp.scm{.tmp,} && \
	$(AWK) 'BEGIN{printf "#!$(SHELL)\n"; \
	              printf "exec $(MIT_SCHEME) --no-init-file --batch-mode "; \
	              printf "--eval \"(find-scheme-libraries! \\\"$(abs_builddir)/r7rs\\\")\" "; \
	              printf "--eval \"(load \\\"$(abs_builddir)/$(@).tmp.scm\\\")\"\n"}' \
	  > $(@).tmp && mv $(@){.tmp,} && chmod +x $(@)

tests/r6rs/%-racket: tests/%.scm $(R6RS_SCHEME) GNUmakefile
	$(call v,AWK) $(MKDIR_P) $(@D) && \
	$(AWK) 'BEGIN{print "'$(R6RS_TEST_TOP)'"} \
	        {print}' $(<) \
	  > $(@).tmp.scm.tmp && mv $(@).tmp.scm{.tmp,} && \
	$(AWK) 'BEGIN{printf "#!$(SHELL)\n"; \
	              printf "exec $(PLT_R6RS) ++path \"$(abs_builddir)/r6rs\" "; \
	              printf "\"$(abs_builddir)/$(@).tmp.scm\"\n"}' \
	  > $(@).tmp && mv $(@){.tmp,} && chmod +x $(@)

tests/r6rs/%-racketbc: tests/%.scm $(R6RS_SCHEME) GNUmakefile
	$(call v,AWK) $(MKDIR_P) $(@D) && \
	$(AWK) 'BEGIN{print "'$(R6RS_TEST_TOP)'"} \
	        {print}' $(<) \
	  > $(@).tmp.scm.tmp && mv $(@).tmp.scm{.tmp,} && \
	$(AWK) 'BEGIN{printf "#!$(SHELL)\n"; \
	              printf "exec $(PLT_R6RSBC) ++path \"$(abs_builddir)/r6rs\" "; \
	              printf "\"$(abs_builddir)/$(@).tmp.scm\"\n"}' \
	  > $(@).tmp && mv $(@){.tmp,} && chmod +x $(@)

tests/r6rs/%-sagittarius: tests/%.scm $(R6RS_SCHEME) GNUmakefile
	$(call v,AWK) $(MKDIR_P) $(@D) && \
	$(AWK) 'BEGIN{print "#!$(ENV_S) $(SAGITTARIUS) -r6 --loadpath='$(abs_builddir)/r6rs'"; \
	              print "'$(R6RS_TEST_TOP)'"} \
	        {print}' $(<) \
	  > $(@).tmp && mv $(@){.tmp,} && chmod +x $(@)

tests/r7rs/%-sagittarius: tests/%.scm $(R7RS_SCHEME) GNUmakefile
	$(call v,AWK) $(MKDIR_P) $(@D) && \
	$(AWK) 'BEGIN{print "#!$(ENV_S) $(SAGITTARIUS) -r7 --loadpath='$(abs_builddir)/r7rs'"; \
	              print "'$(R7RS_TEST_TOP)'"} \
	        {print}' $(<) \
	  > $(@).tmp && mv $(@){.tmp,} && chmod +x $(@)

CLEANFILES += tests/r{6,7}rs/*.tmp{,.scm}
CLEANFILES += tests/r7rs/chicken-5/*.tmp{,.scm}
CLEANFILES += tests/r7rs/chicken-5/*-exe$(EXEEXT)

TESTS =
TESTS += $(TESTS_WE_MADE)

CHEX =
CHEX += tests/check-abstract-syntax-tree.scm
CHEX += tests/check-nix-embed.scm
CHEX += tests/check-nix-list.scm
CHEX += tests/check-nix-set.scm

EXTRA_DIST += $(CHEX)

CHEX_WE_MADE =

CHEX_WE_MADE += $(CHEX:tests/%.scm=tests/r6rs/%-chez)
CHEX_WE_MADE += $(CHEX:tests/%.scm=tests/r6rs/%-guile)
CHEX_WE_MADE += $(CHEX:tests/%.scm=tests/r6rs/%-loko)
CHEX_WE_MADE += $(CHEX:tests/%.scm=tests/r6rs/%-racket)
CHEX_WE_MADE += $(CHEX:tests/%.scm=tests/r6rs/%-racketbc)
CHEX_WE_MADE += $(CHEX:tests/%.scm=tests/r6rs/%-sagittarius)

CHEX_WE_MADE += $(CHEX:tests/%.scm=tests/r7rs/chicken-5/%-csi)
CHEX_WE_MADE += $(CHEX:tests/%.scm=tests/r7rs/chicken-5/%-csc)
CHEX_WE_MADE += $(CHEX:tests/%.scm=tests/r7rs/%-chibi)
CHEX_WE_MADE += $(CHEX:tests/%.scm=tests/r7rs/%-gauche)
CHEX_WE_MADE += $(CHEX:tests/%.scm=tests/r7rs/%-guile)
CHEX_WE_MADE += $(CHEX:tests/%.scm=tests/r7rs/%-loko)
CHEX_WE_MADE += $(CHEX:tests/%.scm=tests/r7rs/%-mit)
CHEX_WE_MADE += $(CHEX:tests/%.scm=tests/r7rs/%-sagittarius)

CLEANFILES += $(CHEX_WE_MADE)

if CHICKEN_INSTALL_5
if CSI_5
BUILT_SOURCES += chicken-5-egg-stamp
TESTS += tests/r7rs/chicken-5/check-abstract-syntax-tree-csi
TESTS += tests/r7rs/chicken-5/check-nix-embed-csi
TESTS += tests/r7rs/chicken-5/check-nix-list-csi
TESTS += tests/r7rs/chicken-5/check-nix-set-csi
endif
if CSC_5
BUILT_SOURCES += chicken-5-egg-stamp
TESTS += tests/r7rs/chicken-5/check-abstract-syntax-tree-csc
TESTS += tests/r7rs/chicken-5/check-nix-embed-csc
TESTS += tests/r7rs/chicken-5/check-nix-list-csc
TESTS += tests/r7rs/chicken-5/check-nix-set-csc
endif
endif

if CHEZ_SCHEME
TESTS += tests/r6rs/check-abstract-syntax-tree-chez
TESTS += tests/r6rs/check-nix-embed-chez
TESTS += tests/r6rs/check-nix-list-chez
TESTS += tests/r6rs/check-nix-set-chez
endif CHEZ_SCHEME

if CHIBI_SCHEME
TESTS += tests/r7rs/check-abstract-syntax-tree-chibi
TESTS += tests/r7rs/check-nix-embed-chibi
TESTS += tests/r7rs/check-nix-list-chibi
TESTS += tests/r7rs/check-nix-set-chibi
endif CHIBI_SCHEME

if GAUCHE
TESTS += tests/r7rs/check-abstract-syntax-tree-gauche
TESTS += tests/r7rs/check-nix-embed-gauche
TESTS += tests/r7rs/check-nix-list-gauche
TESTS += tests/r7rs/check-nix-set-gauche
endif GAUCHE

if GUILE
TESTS += tests/r6rs/check-abstract-syntax-tree-guile
TESTS += tests/r6rs/check-nix-embed-guile
TESTS += tests/r6rs/check-nix-list-guile
TESTS += tests/r6rs/check-nix-set-guile

TESTS += tests/r7rs/check-abstract-syntax-tree-guile
TESTS += tests/r7rs/check-nix-embed-guile
TESTS += tests/r7rs/check-nix-list-guile
TESTS += tests/r7rs/check-nix-set-guile
endif GUILE

if LOKO
TESTS += tests/r6rs/check-abstract-syntax-tree-loko
TESTS += tests/r6rs/check-nix-embed-loko
TESTS += tests/r6rs/check-nix-list-loko
TESTS += tests/r6rs/check-nix-set-loko

TESTS += tests/r7rs/check-abstract-syntax-tree-loko
TESTS += tests/r7rs/check-nix-embed-loko
TESTS += tests/r7rs/check-nix-list-loko
TESTS += tests/r7rs/check-nix-set-loko
endif LOKO

if MIT_SCHEME
TESTS += tests/r7rs/check-abstract-syntax-tree-mit
TESTS += tests/r7rs/check-nix-embed-mit
TESTS += tests/r7rs/check-nix-list-mit
TESTS += tests/r7rs/check-nix-set-mit
endif MIT_SCHEME

if PLT_R6RS
TESTS += tests/r6rs/check-abstract-syntax-tree-racket
TESTS += tests/r6rs/check-nix-embed-racket
TESTS += tests/r6rs/check-nix-list-racket
TESTS += tests/r6rs/check-nix-set-racket
endif PLT_R6RS

if PLT_R6RSBC
TESTS += tests/r6rs/check-abstract-syntax-tree-racketbc
TESTS += tests/r6rs/check-nix-embed-racketbc
TESTS += tests/r6rs/check-nix-list-racketbc
TESTS += tests/r6rs/check-nix-set-racketbc
endif PLT_R6RSBC

if SAGITTARIUS
TESTS += tests/r6rs/check-abstract-syntax-tree-sagittarius
TESTS += tests/r6rs/check-nix-embed-sagittarius
TESTS += tests/r6rs/check-nix-list-sagittarius
TESTS += tests/r6rs/check-nix-set-sagittarius

TESTS += tests/r7rs/check-abstract-syntax-tree-sagittarius
TESTS += tests/r7rs/check-nix-embed-sagittarius
TESTS += tests/r7rs/check-nix-list-sagittarius
TESTS += tests/r7rs/check-nix-set-sagittarius
endif SAGITTARIUS
