# Copyright Â© 2025 Barry Schwartz
# 
# Permission is hereby granted, free of charge, to any person obtaining
# a copy of Pipchix and associated documentation files (the
# "Software"), to deal in the Software without restriction, including
# without limitation the rights to use, copy, modify, merge, publish,
# distribute, sublicense, and/or sell copies of the Software, and to
# permit persons to whom the Software is furnished to do so, subject to
# the following conditions:
# 
# The above copyright notice and this permission notice shall be
# included in all copies or substantial portions of the Software.
# 
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
# EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
# MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
# NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
# LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
# OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
# WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

#
# Tests using the simple parallel test harness of GNU Automake.
#

R6RS_TEST_TOP = '\#!r6rs \
 \
(import (except (rnrs)) \
        (pipchix abstract-syntax-tree) \
        (pipchix nix-embed) \
        (pipchix nix-list) \
        (pipchix nix-set)) \
 \
(define SUCCESS 0) \
(define FAILURE 1) \
(define SKIP 77) \
(define HARD-FAILURE 99) \
 \
(define result (make-string 0)) \
(define (fill-result s) \
  (set! result (string-append result (utf8->string s))))'

R7RS_TEST_TOP = ' \
(import (scheme base)) \
(import (scheme process-context)) \
(import (pipchix abstract-syntax-tree)) \
(import (pipchix nix-embed)) \
(import (pipchix nix-list)) \
(import (pipchix nix-set)) \
 \
(define SUCCESS 0) \
(define FAILURE 1) \
(define SKIP 77) \
(define HARD-FAILURE 99) \
 \
(define result (make-string 0)) \
(define (fill-result s) \
  (set! result (string-append result (utf8->string s))))'

tests/r7rs/chicken-5/%-csi: tests/%.scm $(CHICKEN_5_EGGFILES) \
	                    chicken-5-egg-stamp GNUmakefile
	$(call v,AWK) $(MKDIR_P) $(@D) && \
	$(AWK) 'BEGIN{print "#!$(ENV_S) $(CSI_5) -R r7rs -s"; \
	              print "'$(R7RS_TEST_TOP)'"} \
	        {print}' $(<) \
	  > $(@).tmp && mv $(@){.tmp,} && chmod +x $(@)

tests/r7rs/chicken-5/%-csi.sh: tests/%.scm GNUmakefile
	$(call v,PRINTF) $(MKDIR_P) $(@D) && \
	( \
	  scheme='$(realpath $(<))' && \
	  printf '#!$(SHELL)\n' && \
	  printf 'export CHICKEN_REPOSITORY_PATH\n' && \
	  printf 'CHICKEN_REPOSITORY_PATH="%s"\n' \
	         "$(call get-chicken-5-repository-path)" \
	  printf 'exec $(CSI_5) -R r7rs -n -b -s %s\n' "$${scheme}" \
	) > $(@).tmp && mv $(@){.tmp,} && chmod +x $(@)

tests/r7rs/chicken-5/%-csc: tests/%.scm $(CHICKEN_5_EGGFILES) \
	                    chicken-5-egg-stamp GNUmakefile
	$(call v,AWK) $(MKDIR_P) $(@D) && \
	$(AWK) 'BEGIN{print "'$(R7RS_TEST_TOP)'"} \
	        {print}' $(<) \
	  > $(@).tmp.scm.tmp && mv $(@).tmp.scm{.tmp,} && \
	$(CSC_5) -R r7rs -X r7rs $(@).tmp.scm -o $(@) && \
	rm -f $(@).tmp.scm

tests/r7rs/chicken-5/%-csc.sh: tests/%.scm GNUmakefile
	$(call v,PRINTF) $(MKDIR_P) $(@D) && \
	( \
	  scheme='$(realpath $(<))' && \
	  printf '#!$(SHELL)\n' && \
	  printf 'export CHICKEN_REPOSITORY_PATH\n' && \
	  printf 'CHICKEN_REPOSITORY_PATH="%s"\n' \
	         "$(call get-chicken-5-repository-path)" \
	  printf 'exec %s\n' "$${scheme}" \
	) > $(@).tmp && mv $(@){.tmp,} && chmod +x $(@)

tests/r6rs/%-chez: tests/%.scm $(R6RS_SCHEME) GNUmakefile
	$(call v,AWK) $(MKDIR_P) $(@D) && \
	$(AWK) 'BEGIN{print "#!$(ENV_S) $(CHEZ_SCHEME) --libdirs '$(abs_builddir)/r6rs:' --program"; \
	              print "'$(R6RS_TEST_TOP)'"} \
	        {print}' $(<) \
	  > $(@).tmp && mv $(@){.tmp,} && chmod +x $(@)

tests/r7rs/%-chibi: tests/%.scm $(R7RS_SCHEME) GNUmakefile
	$(call v,AWK) $(MKDIR_P) $(@D) && \
	$(AWK) 'BEGIN{print "#!$(CHIBI_SCHEME) -I'$(abs_builddir)/r7rs'"; \
	              print "'$(R7RS_TEST_TOP)'"} \
	        {print}' $(<) \
	  > $(@).tmp && mv $(@){.tmp,} && chmod +x $(@)

tests/r7rs/%-gauche: tests/%.scm $(R7RS_SCHEME) GNUmakefile
	$(call v,AWK) $(MKDIR_P) $(@D) && \
	$(AWK) 'BEGIN{print "#!$(GAUCHE) -I'$(abs_builddir)/r7rs'"; \
	              print "'$(R7RS_TEST_TOP)'"} \
	        {print}' $(<) \
	  > $(@).tmp && mv $(@){.tmp,} && chmod +x $(@)

tests/r6rs/%-guile: tests/%.scm $(R6RS_SCHEME) GNUmakefile
	$(call v,AWK) $(MKDIR_P) $(@D) && \
	$(AWK) 'BEGIN{print "#!$(GUILE) \\"; \
	              print "-L '$(abs_builddir)/r6rs' --r6rs --no-auto-compile -s"; \
	              print "!#"; \
	              print "'$(R6RS_TEST_TOP)'"} \
	        {print}' $(<) \
	  > $(@).tmp && mv $(@){.tmp,} && chmod +x $(@)

tests/r7rs/%-guile: tests/%.scm $(R7RS_SCHEME) GNUmakefile
	$(call v,AWK) $(MKDIR_P) $(@D) && \
	$(AWK) 'BEGIN{print "#!$(GUILE) \\"; \
	              print "-L '$(abs_builddir)/r7rs' --r7rs --no-auto-compile -s"; \
	              print "!#"; \
	              print "'$(R7RS_TEST_TOP)'"} \
	        {print}' $(<) \
	  > $(@).tmp && mv $(@){.tmp,} && chmod +x $(@)

tests/r6rs/%-mosh: tests/%.scm $(R6RS_SCHEME) GNUmakefile
	$(call v,AWK) $(MKDIR_P) $(@D) && \
	$(AWK) 'BEGIN{print "#!$(ENV_S) $(MOSH) --disable-acc --loadpath='$(abs_builddir)/r6rs'"; \
	              print "'$(R6RS_TEST_TOP)'"} \
	        {print}' $(<) \
	  > $(@).tmp && mv $(@){.tmp,} && chmod +x $(@)

tests/r7rs/%-mosh: tests/%.scm $(R7RS_SCHEME) GNUmakefile
	$(call v,AWK) $(MKDIR_P) $(@D) && \
	$(AWK) 'BEGIN{print "#!$(ENV_S) $(MOSH) --disable-acc --loadpath='$(abs_builddir)/r7rs'"; \
	              print "'$(R7RS_TEST_TOP)'"} \
	        {print}' $(<) \
	  > $(@).tmp && mv $(@){.tmp,} && chmod +x $(@)

tests/r6rs/%-sagittarius: tests/%.scm $(R6RS_SCHEME) GNUmakefile
	$(call v,AWK) $(MKDIR_P) $(@D) && \
	$(AWK) 'BEGIN{print "#!$(ENV_S) $(SAGITTARIUS) -r6 --loadpath='$(abs_builddir)/r6rs'"; \
	              print "'$(R6RS_TEST_TOP)'"} \
	        {print}' $(<) \
	  > $(@).tmp && mv $(@){.tmp,} && chmod +x $(@)

tests/r7rs/%-sagittarius: tests/%.scm $(R7RS_SCHEME) GNUmakefile
	$(call v,AWK) $(MKDIR_P) $(@D) && \
	$(AWK) 'BEGIN{print "#!$(ENV_S) $(SAGITTARIUS) -r7 --loadpath='$(abs_builddir)/r7rs'"; \
	              print "'$(R7RS_TEST_TOP)'"} \
	        {print}' $(<) \
	  > $(@).tmp && mv $(@){.tmp,} && chmod +x $(@)

CLEANFILES += tests/r6rs/*.tmp
CLEANFILES += tests/r7rs/*.tmp
CLEANFILES += tests/r7rs/chicken-5/*.tmp
CLEANFILES += tests/r7rs/chicken-5/*-csc.tmp.scm

TESTS =
TESTS += $(TESTS_WE_MADE)

CHEX =
CHEX += tests/check-nix-embed.scm
CHEX += tests/check-nix-list.scm
CHEX += tests/check-nix-set.scm

EXTRA_DIST += $(CHEX)

CHEX_WE_MADE =

CHEX_WE_MADE += $(CHEX:tests/%.scm=tests/r6rs/%-chez)
CHEX_WE_MADE += $(CHEX:tests/%.scm=tests/r6rs/%-guile)
CHEX_WE_MADE += $(CHEX:tests/%.scm=tests/r6rs/%-mosh)
CHEX_WE_MADE += $(CHEX:tests/%.scm=tests/r6rs/%-sagittarius)

CHEX_WE_MADE += $(CHEX:tests/%.scm=tests/r7rs/chicken-5/%-csi.sh)
CHEX_WE_MADE += $(CHEX:tests/%.scm=tests/r7rs/chicken-5/%-csc.sh)
CHEX_WE_MADE += $(CHEX:tests/%.scm=tests/r7rs/%-chibi)
CHEX_WE_MADE += $(CHEX:tests/%.scm=tests/r7rs/%-gauche)
CHEX_WE_MADE += $(CHEX:tests/%.scm=tests/r7rs/%-guile)
CHEX_WE_MADE += $(CHEX:tests/%.scm=tests/r7rs/%-mosh)
CHEX_WE_MADE += $(CHEX:tests/%.scm=tests/r7rs/%-sagittarius)

CLEANFILES += $(CHEX_WE_MADE)
CLEANFILES += $(CHEX:tests/%.scm=tests/r7rs/chicken-5/%-csi)
CLEANFILES += $(CHEX:tests/%.scm=tests/r7rs/chicken-5/%-csc)

if CHICKEN_INSTALL_5
if CSI_5
TESTS += tests/r7rs/chicken-5/check-nix-embed-csi.sh
TESTS += tests/r7rs/chicken-5/check-nix-list-csi.sh
TESTS += tests/r7rs/chicken-5/check-nix-set-csi.sh
endif
if CSC_5
TESTS += tests/r7rs/chicken-5/check-nix-embed-csc.sh
TESTS += tests/r7rs/chicken-5/check-nix-list-csc.sh
TESTS += tests/r7rs/chicken-5/check-nix-set-csc.sh
endif
endif

if CHEZ_SCHEME
TESTS += tests/r6rs/check-nix-embed-chez
TESTS += tests/r6rs/check-nix-list-chez
TESTS += tests/r6rs/check-nix-set-chez
endif CHEZ_SCHEME

if CHIBI_SCHEME
TESTS += tests/r7rs/check-nix-embed-chibi
TESTS += tests/r7rs/check-nix-list-chibi
TESTS += tests/r7rs/check-nix-set-chibi
endif CHIBI_SCHEME

if GAUCHE
TESTS += tests/r7rs/check-nix-embed-gauche
TESTS += tests/r7rs/check-nix-list-gauche
TESTS += tests/r7rs/check-nix-set-gauche
endif GAUCHE

if GUILE
TESTS += tests/r6rs/check-nix-embed-guile
TESTS += tests/r6rs/check-nix-list-guile
TESTS += tests/r6rs/check-nix-set-guile

TESTS += tests/r7rs/check-nix-embed-guile
TESTS += tests/r7rs/check-nix-list-guile
TESTS += tests/r7rs/check-nix-set-guile
endif GUILE

if MOSH
TESTS += tests/r6rs/check-nix-embed-mosh
TESTS += tests/r6rs/check-nix-list-mosh
TESTS += tests/r6rs/check-nix-set-mosh

TESTS += tests/r7rs/check-nix-embed-mosh
TESTS += tests/r7rs/check-nix-list-mosh
TESTS += tests/r7rs/check-nix-set-mosh
endif MOSH

if SAGITTARIUS
TESTS += tests/r6rs/check-nix-embed-sagittarius
TESTS += tests/r6rs/check-nix-list-sagittarius
TESTS += tests/r6rs/check-nix-set-sagittarius

TESTS += tests/r7rs/check-nix-embed-sagittarius
TESTS += tests/r7rs/check-nix-list-sagittarius
TESTS += tests/r7rs/check-nix-set-sagittarius
endif SAGITTARIUS
